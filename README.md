# Smart Thermostat — Home Assistant

Интеграция Home Assistant (domain: `smart_thermostat`) для “умного” управления TRV/термостатом по **одному или нескольким комнатным датчикам температуры**. Контроллер выставляет уставку через `climate.set_temperature`, поддерживает **окно открыто**, **Boost**, **самообучение offset** (включая stable learning), **затухание offset**, а также хранит историю/статистику в `storage`.

**Версия:** 1.2.0  
**IoT Class:** `local_polling`  
**Config Flow:** ✅ (настройка через UI)

---

## Возможности

- Усреднение температуры по нескольким `sensor.*` (комнатные датчики).
- Управление целевым `climate.*`:
  - периодический контроль с интервалом `interval_sec`
  - лимиты уставки `trv_min..trv_max`
  - ограничение шага изменения `step_min..step_max`
  - защита от “спама” установок через `cooldown_sec`
- Окна (`binary_sensor.*`):
  - при открытом окне выставляет `trv_min`
  - может отключать/замораживать обучение после длительного открытия (параметр `window_open_no_learn_min`)
- Boost:
  - на `boost_duration_sec` выставляет `trv_max`
- Самообучение offset:
  - активное и “stable learning” после `stable_learn_seconds`
  - затухание offset при простое (`offset_decay_rate/threshold`)
- Динамика/overshoot:
  - оценка скорости нагрева (EMA через `heating_alpha`)
  - учёт перегрева (`overshoot_threshold`) + история/счётчик
  - упрощённый TTT (`ttt_*`)
- Anti-stuck (опционально): “перегрето и не остывает” (`stuck_*`, `max_stuck_bias`).
- Учёт наружной температуры (датчик или weather entity) с линейной компенсацией уставки при холоде.

---

## Установка

### Вручную (custom component)

1. Скопируйте папку интеграции в:
   `config/custom_components/smart_thermostat/`
2. Перезапустите Home Assistant.

### Через HACS (если репозиторий добавлен)

1. HACS → Integrations → Custom repositories → добавить репозиторий (Integration).
2. Установить интеграцию и перезапустить Home Assistant.

---

## Настройка (UI)

### Добавление интеграции

Settings → Devices & services → Add integration → **Smart Thermostat**

Поля:
- **Термостат** (`climate_entity`) — один `climate.*`
- **Датчики температуры помещения** (`room_sensor_entities`) — один или несколько `sensor.*`
- **Датчики окна (опционально)** (`window_sensor_entities`) — один или несколько `binary_sensor.*`
- **Целевая температура в помещении** (`room_target`) — в °C

> Один и тот же `climate_entity` нельзя добавить дважды.

### Опции (Configure)

Settings → Devices & services → Smart Thermostat → Configure

#### Основные параметры
- **Датчики окна (binary_sensor)**  
  Если любой из датчиков покажет «открыто», термостат снизит уставку до минимальной и приостановит обучение. Полезно для проветривания.
- **Интервал управления (секунды)** (по умолчанию 240)  
  Как часто контроллер проверяет температуру и принимает решения. Меньше — быстрее реакция, но больше нагрузка на систему. Рекомендуется 120–300 сек.
- **Мёртвая зона (°C)** (по умолчанию 0.2)  
  Диапазон вокруг цели, в котором контроллер не меняет уставку. Увеличивает стабильность и снижает частые переключения радиатора.
- **Максимальное изменение за шаг (°C)** (по умолчанию 1.0)  
  Максимум, на сколько контроллер может изменить уставку за один тик. Предотвращает резкие скачки.
- **Минимальный шаг изменения (°C)** (по умолчанию 0.5)  
  Уставка всегда округляется до этого шага. Полезно для совместимости с TRV, которые поддерживают только определённые значения (0.5°C и т.п.).
- **Минимальная уставка термостата (°C)** (по умолчанию 12.0)  
  Нижний предел, до которого контроллер может снижать уставку (например, при открытом окне).
- **Максимальная уставка термостата (°C)** (по умолчанию 30.0)  
  Верхний предел уставки (для режима Boost и быстрого нагрева).
- **Пауза между изменениями уставки (секунды)** (по умолчанию 600)  
  Минимальное время между отправкой команд на термостат. Защищает от слишком частых изменений.
- **Датчик наружной температуры**  
  Датчик температуры снаружи дома. Если температура низкая — контроллер добавляет компенсацию к уставке для предиктивного нагрева.
- **Погодная сущность**  
  Weather entity (например, weather.home). Используется как альтернативный источник наружной температуры (attributes['temperature']).

#### Обучение
- **Включить обучение** (по умолчанию включено)  
  Включает/выключает автоматическую компенсацию тепловой инерции и смещения. При выключении контроллер работает как простой пропорциональный регулятор.
- **Скорость быстрого обучения** (по умолчанию 0.5)  
  Как быстро корректируется смещение, когда ошибка большая (> deadband). Большее значение — быстрее адаптация, но возможны колебания.
- **Скорость медленного обучения** (по умолчанию 0.1)  
  Как быстро корректируется смещение вблизи цели. Меньшее значение — более плавная и стабильная работа.
- **Минимальное изменение смещения (°C)** (по умолчанию 0.2)  
  Смещение обновляется только если изменение превышает это значение. Уменьшает мелкие колебания.
- **Не обучаться летом (июнь-август)** (по умолчанию выключено)  
  Отключает обучение в летние месяцы, когда обогрев обычно не нужен и данные могут быть искажены.
- **Не обучаться при открытом окне дольше (минуты)** (по умолчанию 600)  
  Если окно открыто дольше указанного времени, обучение приостанавливается. Предотвращает неверное обучение при проветривании.
- **Порог для стабильного обучения (°C)** (по умолчанию 0.5)  
  Разница между текущим и предполагаемым смещением должна превышать этот порог, чтобы применить стабильное обучение.
- **Период стабильности для обучения (секунды)** (по умолчанию 900)  
  Сколько времени температура должна находиться в мёртвой зоне, чтобы применить стабильное обучение смещения.
- **Сила стабильного обучения** (по умолчанию 0.25)  
  На сколько процентов смещение сдвигается к «идеальному» значению за один период стабильности (0.05 — медленно, 0.5 — быстро).
- **Скорость затухания смещения (% в день)** (по умолчанию 0.01)  
  Смещение постепенно уменьшается к нулю, если давно не обновлялось. Помогает адаптироваться к смене сезона.
- **Минимальное смещение для затухания (°C)** (по умолчанию 0.1)  
  Затухание начинается только если |смещение| больше этого значения.

#### Boost
- **Длительность режима Boost (секунды)** (по умолчанию 300)  
  Сколько длится режим максимального нагрева при активации Boost.

#### Overshoot / динамика
- **Скорость адаптации скорости нагрева** (по умолчанию 0.1)  
  Коэффициент экспоненциального сглаживания для оценки скорости нагрева помещения (0.01 — очень медленно, 0.5 — быстро).
- **Порог обнаружения перегрева (°C)** (по умолчанию 0.5)  
  Если температура превысит цель больше чем на это значение, считается перегрев и замедляется обучение.
- **Горизонт предсказания времени нагрева (минуты)** (по умолчанию 5)  
  На сколько минут вперёд контроллер пытается предсказать достижение цели, чтобы избежать перегрева.
- **Скорость обучения времени до цели (TTT)** (по умолчанию 0.2)  
  Коэффициент сглаживания для оценки времени, необходимого для нагрева 1°C. 0.05 — медленно, 0.5 — быстро.
- **Минимальное время для мягкой посадки (минуты)** (по умолчанию 10)  
  Если предсказанное время до цели меньше этого значения, контроллер начинает плавно снижать уставку, чтобы избежать перегрева.

#### Anti-stuck
- **Включить детектор залипания/перегрева** (по умолчанию включено)  
  Включает механизм, который снижает уставку, если температура долго не падает при ошибке в сторону перегрева.
- **Период наблюдения за перегревом (секунды)** (по умолчанию 1800)  
  Сколько времени температура должна не снижаться, чтобы сработал детектор залипания.
- **Минимальное требуемое падение температуры (°C)** (по умолчанию 0.10)  
  За указанный период температура должна упасть хотя бы на это значение, иначе считается «залипание».
- **Шаг дополнительного снижения при перегреве (°C)** (по умолчанию 0.5)  
  На сколько снижается уставка при срабатывании детектора залипания.
- **Максимальное накопленное снижение при залипании (°C)** (по умолчанию 4.0)  
  Верхний предел дополнительного снижения уставки при многократном срабатывании детектора залипания.

---

## Хранилище данных (storage)

Используется `homeassistant.helpers.storage.Store`:

- `key`: `smart_thermostat`
- `version`: 1

Данные по `entry_id`:
- `offset`, `last_offset_change`, `last_offset_value`, `total_changes`
- `offset_history` (до 100 записей)
- `heating_rate` + `heating_rate_history` (до 50)
- `overshoot_count` + `overshoot_history` (до 50)
- `minutes_per_degree`

Отдельная история контроллера:
- ключ `history_{entry_id}`

Ограничения:
- хранение истории: **до 7 дней**
- сохранение с debounce: ~2 секунды (есть `force=True`)